<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Admin Dashboard â€“ IT Tickets</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 10px; }
    .ticket { border: 1px solid #ccc; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .ticket-header { display: flex; justify-content: space-between; align-items: center; }
    .controls { margin-top: 8px; }
    .comment-box { width: 100%; margin-top: 6px; padding: 4px; }

    /* Hide header on screen, show only on print */
    .print-header { display: none; text-align: center; margin-bottom: 20px; }
    .print-header img { height: 60px; margin-bottom: 10px; }
    .print-header h2 { margin: 0; }
    .print-header .date { font-size: 14px; color: #444; }

    @media print {
      .no-print { display: none !important; }
      .print-header { display: block; }
      .ticket { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <!-- Header that appears only when printing -->
  <div class="print-header">
    <img src="/navy-logo.png" alt="Saudi Royal Navy Logo"/>
    <h2>Saudi Royal Navy â€“ IT Ticket Report</h2>
    <div class="date" id="reportDate"></div>
  </div>

  <h1>Admin Dashboard</h1>
  <button class="no-print" onclick="loadTickets()">ðŸ”„ Refresh</button>
  <button class="no-print" onclick="window.print()">ðŸ–¨ Print</button>
  <button class="no-print" onclick="window.location='/admin/export.csv'">â¬‡ Export CSV</button>
  <div id="tickets"></div>
  <div class="creator">&copy; 2025 Nasser Dawood. All rights reserved.</div>


  <script>
    async function loadTickets() {
      const res = await fetch('/api/tickets');
      const data = await res.json();
      const wrap = document.getElementById('tickets');
      wrap.innerHTML = '';
      if (!data.ok) return wrap.textContent = 'Error loading tickets';
      data.tickets.forEach(t => {
        const div = document.createElement('div');
        div.className = 'ticket';
        div.innerHTML = `
          <div class="ticket-header">
            <strong>#${t.id} â€“ ${t.username} (${t.department})</strong>
            <em>${t.ts_local}</em>
          </div>
          <div><b>Issue:</b> ${t.issue}</div>
          <div><b>Status:</b> ${t.status}</div>
          <div class="controls no-print">
            <label>
              <input type="checkbox" ${t.status === 'Resolved' ? 'checked' : ''} 
                     onchange="updateStatus(${t.id}, this.checked ? 'Resolved' : 'In Progress')"> Mark Resolved
            </label>
            <br/>
            <textarea class="comment-box" placeholder="Add comment...">${t.comment || ''}</textarea>
            <button onclick="saveComment(${t.id}, this.previousElementSibling.value)">ðŸ’¾ Save</button>
          </div>
        `;
        wrap.appendChild(div);
      });
    }

    async function updateStatus(id, status) {
      await fetch('/api/tickets/' + id + '/status', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status })
      });
      loadTickets();
    }

    async function saveComment(id, comment) {
      await fetch('/api/tickets/' + id + '/comment', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ comment })
      });
      loadTickets();
    }

    // Add current date to print header
    document.getElementById('reportDate').textContent = 
      "Report Date: " + new Date().toLocaleString();

    loadTickets();
    
  </script>
</body>
</html>
