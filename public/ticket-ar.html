<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام تذاكر الدعم - عربي</title>
  <style>
    :root { --bg:#0b0e14; --card:#141a22; --muted:#8aa1b1; --text:#e6eef5; --ok:#2fb171; --warn:#e3b341; --bad:#e05d5d; }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
    h1{margin:0 0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 4px 18px #0008}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;margin:8px 0;align-items:center}
    label{color:var(--muted)}
    input,textarea{width:100%;box-sizing:border-box;background:#0f141b;border:1px solid #243244;color:var(--text);border-radius:10px;padding:10px}
    textarea{min-height:90px;resize:vertical}
    button{background:#1c2c3b;border:1px solid #2a3f55;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    .btn-ok{background:#153425;border-color:#2c744d}
    .btn-warn{background:#3a2f14;border-color:#6c5824}
    .btn-bad{background:#3a1b1b;border-color:#6c2a2a}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .left{margin-right:auto}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#233246;border:1px solid #2f4663;color:#cfe1f5;font-size:12px}
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border-bottom:1px solid #223046;padding:10px;vertical-align:top}
    .ai{background:#0f1620;border:1px dashed #29507a;border-radius:12px;padding:10px;margin-top:8px}
    .small{font-size:12px}
    a.switch{color:#9dd1ff;text-decoration:none}
    a.switch:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="flex" style="margin-bottom:8px">
      <h1 style="margin:0">نظام تذاكر الدعم (عربي)</h1>
      <a class="switch left" href="/ticket-en" title="English version">English</a>
    </div>
    <div class="grid">
      <!-- إرسال تذكرة -->
      <section class="card">
        <div class="flex">
          <h2 style="margin:0">إرسال تذكرة</h2>
          <span class="muted small left">سيم التقاط اسم جهازك من الخادم</span>
        </div>
        <form id="formTicket">
          <div class="row">
            <label for="username">الاسم</label>
            <input id="username" name="username" required />
          </div>
          <div class="row">
            <label for="email">البريد الإلكتروني</label>
            <input id="email" name="email" type="email" required />
          </div>
          <div class="row">
            <label for="extension">التحويلة</label>
            <input id="extension" name="extension" inputmode="numeric" />
          </div>
          <div class="row">
            <label for="department">القسم</label>
            <input id="department" name="department" />
          </div>
          <div class="row">
            <label for="issue">المشكلة</label>
            <textarea id="issue" name="issue" placeholder="وصف المشكلة بالتفصيل…"></textarea>
          </div>

          <div class="ai" id="aiBox" style="display:none">
            <div class="flex">
              <strong>اقتراح الذكاء الاصطناعي</strong>
              <span class="muted small left" id="aiConf"></span>
            </div>
            <div id="aiTitle" style="margin:4px 0 6px;color:#8ef5c8"></div>
            <ol id="aiSteps" class="small" style="margin:0 0 6px 18px"></ol>
          </div>

          <div class="flex" style="margin-top:10px">
            <button class="btn-ok" type="submit">إرسال</button>
            <span class="muted small" id="submitMsg"></span>
          </div>
        </form>
      </section>

      <!-- تذاكري -->
      <section class="card">
        <div class="flex">
          <h2 style="margin:0">تذاكري</h2>
          <span class="muted small left">أدخل بريدك لعرض السجل</span>
        </div>
        <div class="row">
          <label for="myEmail">بريدك</label>
          <input id="myEmail" type="email" placeholder="me@company.com" />
        </div>
        <div class="flex" style="margin:6px 0 10px">
          <button id="btnLoad">عرض تذاكري</button>
          <span class="muted small" id="myMsg"></span>
        </div>
        <div id="myList"></div>
      </section>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const base = '';

    // خريطة ترجمة الحالات للعرض فقط
    const statusAr = {
      'New': 'جديد',
      'In Progress': 'قيد الإنجاز',
      'Resolved': 'تم الحل',
      'AI Suggested': 'اقتراح الذكاء الاصطناعي',
      'Dismissed by AI': 'مرفوض من الذكاء الاصطناعي'
    };

    // -------- معاينة اقتراح AI --------
    const issueEl = $('#issue');
    const aiBox = $('#aiBox'), aiTitle = $('#aiTitle'), aiSteps = $('#aiSteps'), aiConf = $('#aiConf');
    let aiTimer = null;

    issueEl.addEventListener('input', () => {
      clearTimeout(aiTimer);
      const text = issueEl.value.trim();
      if (!text) { aiBox.style.display = 'none'; return; }
      aiTimer = setTimeout(async () => {
        try {
          const r = await fetch(base + '/ai-suggest', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ issue: text })
          });
          const j = await r.json();
          if (j?.ok && j.suggestions?.length) {
            const s = j.suggestions[0];
            aiTitle.textContent = s.title || '';
            aiConf.textContent = (typeof s.confidence === 'number') ? `الثقة: ${s.confidence}` : '';
            aiSteps.innerHTML = '';
            (Array.isArray(s.steps) ? s.steps : String(s.steps||'').split(/[\r\n]+/)).forEach(step => {
              if (!step) return;
              const li = document.createElement('li'); li.textContent = step; aiSteps.appendChild(li);
            });
            aiBox.style.display = 'block';
          } else {
            aiBox.style.display = 'none';
          }
        } catch { aiBox.style.display = 'none'; }
      }, 350);
    });

    // -------- إرسال تذكرة --------
    const submitMsg = $('#submitMsg');
    $('#formTicket').addEventListener('submit', async (e) => {
      e.preventDefault();
      submitMsg.textContent = 'يتم الإرسال…';
      const payload = {
        username:  $('#username').value.trim(),
        email:     $('#email').value.trim(),
        extension: $('#extension').value.trim(),
        department:$('#department').value.trim(),
        issue:     $('#issue').value.trim(),
      };
      try {
        const r = await fetch(base + '/ticket', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (j?.ok) {
          submitMsg.textContent = `تم إنشاء التذكرة رقم ${j.ticket}`;
          const m = $('#myEmail').value.trim().toLowerCase();
          if (m && m === payload.email.toLowerCase()) loadMyTickets();
        } else {
          submitMsg.textContent = 'فشل الإرسال.';
        }
      } catch {
        submitMsg.textContent = 'خطأ في الشبكة.';
      }
    });

    // -------- تذاكري (عرض / تحديث / حذف) --------
    const myEmail = $('#myEmail'), myMsg = $('#myMsg'), myList = $('#myList');
    $('#btnLoad').addEventListener('click', loadMyTickets);
    $('#email').addEventListener('blur', () => { if (!myEmail.value) myEmail.value = $('#email').value; });

    function rowHtml(t) {
      const esc = s => String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      const statusDisp = statusAr[t.status] || t.status || 'جديد';
      return `
        <tr data-id="${t.id}">
          <td>#${t.id}</td>
          <td class="small">${esc(t.ts_local||'')}</td>
          <td>${esc(t.issue||'')}</td>
          <td><span class="pill">${esc(statusDisp)}</span></td>
          <td class="small">
            <div class="flex">
              <button class="btn-ok" data-action="set" data-status="Resolved" title="تم الحل">تم الحل</button>
              <button class="btn-warn" data-action="set" data-status="In Progress" title="قيد الإنجاز">قيد الإنجاز</button>
              <button class="btn-bad" data-action="del" title="حذف">حذف</button>
            </div>
          </td>
        </tr>`;
    }

    async function loadMyTickets() {
      const email = myEmail.value.trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { myMsg.textContent = 'فضلاً أدخل بريد صحيح.'; return; }
      myMsg.textContent = 'جاري التحميل…';
      myList.innerHTML = '';
      try {
        const r = await fetch(base + '/api/my-tickets?email=' + encodeURIComponent(email));
        const j = await r.json();
        if (!j?.ok) throw new Error('Bad response');
        if (!j.tickets?.length) { myMsg.textContent = 'لا توجد تذاكر حتى الآن.'; return; }
        myMsg.textContent = `${j.tickets.length} تذكرة.`;
        const rows = j.tickets.map(rowHtml).join('');
        myList.innerHTML = `
          <table class="table">
            <thead><tr><th>الرقم</th><th>الوقت</th><th>المشكلة</th><th>الحالة</th><th>إجراءات</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
      } catch {
        myMsg.textContent = 'فشل التحميل.';
      }
    }

    myList.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button'); if (!btn) return;
      const tr  = ev.target.closest('tr'); if (!tr) return;
      const id  = tr.getAttribute('data-id');
      const email = myEmail.value.trim();

      if (btn.dataset.action === 'set') {
        const status = btn.dataset.status; // EN value required by server
        btn.disabled = true;
        try {
          const r = await fetch(base + `/api/my-tickets/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ email, status })
          });
          const j = await r.json();
          if (j?.ok) {
            tr.querySelector('.pill').textContent = statusAr[status] || status;
          } else {
            alert('فشل التحديث: ' + (j?.error||'')); 
          }
        } catch {
          alert('خطأ في الشبكة أثناء التحديث.');
        } finally {
          btn.disabled = false;
        }
      }

      if (btn.dataset.action === 'del') {
        if (!confirm('حذف هذه التذكرة؟')) return;
        btn.disabled = true;
        try {
          const r = await fetch(base + `/api/my-tickets/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ email })
          });
          const j = await r.json();
          if (j?.ok) tr.remove();
          else alert('فشل الحذف: ' + (j?.error||''));
        } catch {
          alert('خطأ في الشبكة أثناء الحذف.');
        } finally {
          btn.disabled = false;
        }
      }
    });

    window.addEventListener('load', () => { if (myEmail.value) loadMyTickets(); });
  </script>
</body>
</html>
