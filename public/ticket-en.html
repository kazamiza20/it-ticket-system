<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IT Ticket – English</title>
  <style>
    :root { --bg:#0b0e14; --card:#141a22; --muted:#8aa1b1; --text:#e6eef5; --ok:#2fb171; --warn:#e3b341; --bad:#e05d5d; }
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:20px auto;padding:0 16px}
    h1{font-weight:700;margin:0 0 14px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 4px 18px #0008}
    .row{display:grid;grid-template-columns:160px 1fr;gap:10px;margin:8px 0;align-items:center}
    label{color:var(--muted)}
    input,select,textarea{width:100%;box-sizing:border-box;background:#0f141b;border:1px solid #243244;color:var(--text);border-radius:10px;padding:10px}
    textarea{min-height:90px;resize:vertical}
    button{background:#1c2c3b;border:1px solid #2a3f55;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    .btn-ok{background:#153425;border-color:#2c744d}
    .btn-warn{background:#3a2f14;border-color:#6c5824}
    .btn-bad{background:#3a1b1b;border-color:#6c2a2a}
    .muted{color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .hl{color:var(--ok)}
    .error{color:var(--bad);white-space:pre-wrap}
    .table{width:100%;border-collapse:collapse;margin-top:10px}
    .table th,.table td{border-bottom:1px solid #223046;padding:10px;vertical-align:top}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#233246;border:1px solid #2f4663;color:#cfe1f5;font-size:12px}
    .ai{background:#0f1620;border:1px dashed #29507a;border-radius:12px;padding:10px;margin-top:8px}
    .small{font-size:12px}
  </style>

<!-- START: inherited theme from admin-login.html -->
<style>
:root{
      --ink:#0b1f33; --bg:#0f1d2b; --card:#0f2640; --muted:#8aa0b2; --brand:#0a66c2; --accent:#00b894;
      --ring:rgba(10,102,194,.35);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f5f7fb; --card:#ffffff; --ink:#0b1f33; --muted:#5c6b7a; }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      color:var(--ink); background:
      radial-gradient(1200px 600px at 80% -10%, rgba(10,102,194,.18), transparent 60%),
      radial-gradient(900px 500px at -10% 100%, rgba(0,184,148,.18), transparent 60%),
      var(--bg);
      min-height:100vh; display:grid; place-items:center;
    }
    .wrap{ width:min(420px, 92vw); }
    .card{
      background:var(--card); padding:28px; border-radius:16px;
      box-shadow:0 18px 50px rgba(7, 23, 44, .25), 0 2px 8px rgba(7, 23, 44, .15);
      border:1px solid rgba(255,255,255,.06);
      backdrop-filter: blur(6px);
    }
    h1{ margin:0 0 6px 0; font-size:1.35rem; letter-spacing:.2px }
    p.sub{ margin:0 0 18px 0; color:var(--muted) }
    .brand{ display:flex; align-items:center; gap:10px; margin-bottom:16px }
    .logo{
      width:42px; height:42px; border-radius:12px;
      background: linear-gradient(135deg, #0a66c2, #00b894);
      box-shadow:inset 0 0 10px rgba(255,255,255,.25);
    }
    label{ display:block; font-size:.9rem; margin:12px 0 6px 4px }
    .field{
      position:relative;
    }
    input[type="password"], input[type="text"]{
      width:100%; padding:12px 40px 12px 12px; border-radius:12px;
      border:1px solid rgba(102,119,136,.25); outline:none; font-size:1rem;
      background:rgba(255,255,255,.9);
    }
    input:focus{ border-color: var(--brand); box-shadow:0 0 0 4px var(--ring) }
    .toggle{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      border:none; background:transparent; cursor:pointer; font-size:.9rem; color:#335;
    }
    .caps{ font-size:.8rem; color:#b00020; min-height:18px; margin:6px 4px 0 }
    .cta{
      margin-top:12px; width:100%; padding:12px 14px; border:none; border-radius:12px;
      background: linear-gradient(135deg, #0a66c2, #00b894); color:white; font-weight:700; cursor:pointer;
      box-shadow:0 10px 20px rgba(10,102,194,.25);
    }
    .meta{ display:flex; align-items:center; justify-content:space-between; margin-top:10px; color:var(--muted); font-size:.85rem }
    .hint{ margin-top:16px; color:var(--muted); font-size:.85rem }
    .err{ color:#b00020; min-height:18px; margin-top:8px }
    footer{ margin-top:14px; text-align:center; color:var(--muted); font-size:.8rem }
    @media (max-width:420px){ .brand{justify-content:center} }
</style>
<!-- END: inherited theme from admin-login.html -->

</head>
<body>
<!-- START: fixed corner logo -->
<a class="brand-logo" href="lang.html" aria-label="Home">
  <img src="navy-logo.png" alt="Navy logo">
</a>
<style>
  .brand-logo{
    position: fixed;
    top: 18px;
    left: 18px;
    display: inline-block;
    z-index: 9999;
    width: 44px;
    height: 44px;
    border-radius: 12px;
    overflow: hidden;
    background: linear-gradient(135deg, rgba(10,102,194,.2), rgba(0,184,148,.2));
    backdrop-filter: blur(4px);
    box-shadow: 0 10px 28px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.08);
  }
  .brand-logo img{
    width: 100%; height: 100%; object-fit: cover; display:block;
    border-radius: 12px;
  }
  @media (max-width: 480px){
    .brand-logo{ width:36px; height:36px; top:12px; left:12px; }
  }
</style>
<!-- END: fixed corner logo -->

  <div class="wrap">
    <h1>IT Ticket (English)</h1>
    <div class="grid">
      <!-- Submit -->
      <section class="card" id="card-submit">
        <div class="flex">
          <h2 style="margin:0">Submit a ticket</h2>
          <span class="muted right small">Your PC name auto-detected server-side</span>
        </div>
        <form id="formTicket">
          <div class="row">
            <label for="username">Name</label>
            <input id="username" name="username" autocomplete="name" required />
          </div>
          <div class="row">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="email" required />
          </div>
          <div class="row">
            <label for="extension">Extension</label>
            <input id="extension" name="extension" inputmode="numeric" />
          </div>
          <div class="row">
            <label for="department">Department</label>
            <input id="department" name="department" />
          </div>
          <div class="row">
            <label for="issue">Issue</label>
            <textarea id="issue" name="issue" placeholder="Describe the problem…"></textarea>
          </div>
          <div class="ai" id="aiBox" style="display:none">
            <div class="flex">
              <strong>AI suggestion</strong>
              <span class="muted small right" id="aiConf"></span>
            </div>
            <div id="aiTitle" class="hl" style="margin:4px 0 6px"></div>
            <ol id="aiSteps" class="small" style="margin:0 0 6px 18px"></ol>
          </div>
          <div class="flex" style="margin-top:10px">
            <button class="btn-ok" type="submit">Submit</button>
            <span class="muted small" id="submitMsg"></span>
          </div>
        </form>
      </section>

      <!-- My tickets -->
      <section class="card" id="card-my">
        <div class="flex">
          <h2 style="margin:0">My tickets</h2>
          <span class="muted right small">Type your email to view history</span>
        </div>
        <div class="row">
          <label for="myEmail">Your email</label>
          <input id="myEmail" type="email" placeholder="me@company.com" />
        </div>
        <div class="flex" style="margin:6px 0 10px">
          <button id="btnLoad">Load my tickets</button>
          <span class="muted small" id="myMsg"></span>
        </div>
        <div id="myList"></div>
      </section>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const base = '';

    // -------- AI live suggestion (debounced) --------
    const issueEl = $('#issue');
    const aiBox = $('#aiBox'), aiTitle = $('#aiTitle'), aiSteps = $('#aiSteps'), aiConf = $('#aiConf');
    let aiTimer = null;
    issueEl.addEventListener('input', () => {
      clearTimeout(aiTimer);
      const text = issueEl.value.trim();
      if (!text) { aiBox.style.display='none'; return; }
      aiTimer = setTimeout(async () => {
        try {
          const r = await fetch(base + '/ai-suggest', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ issue: text })
          });
          const j = await r.json();
          if (j?.ok && j.suggestions?.length) {
            const s = j.suggestions[0];
            aiTitle.textContent = s.title || '';
            aiConf.textContent = (typeof s.confidence === 'number') ? `confidence: ${s.confidence}` : '';
            aiSteps.innerHTML = '';
            (Array.isArray(s.steps) ? s.steps : String(s.steps||'').split(/[\r\n]+/)).forEach(step => {
              if (!step) return;
              const li = document.createElement('li'); li.textContent = step; aiSteps.appendChild(li);
            });
            aiBox.style.display = 'block';
          } else {
            aiBox.style.display = 'none';
          }
        } catch { aiBox.style.display = 'none'; }
      }, 350);
    });

    // -------- Submit a ticket --------
    const submitMsg = $('#submitMsg');
    $('#formTicket').addEventListener('submit', async (e) => {
      e.preventDefault();
      submitMsg.textContent = 'Submitting…';
      const payload = {
        username:  $('#username').value.trim(),
        email:     $('#email').value.trim(),
        extension: $('#extension').value.trim(),
        department:$('#department').value.trim(),
        issue:     $('#issue').value.trim(),
      };
      try {
        const r = await fetch(base + '/ticket', {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (j?.ok) {
          submitMsg.textContent = `Created ticket #${j.ticket}`;
          // refresh "My tickets" if emails match
          const m = $('#myEmail').value.trim().toLowerCase();
          if (m && m === payload.email.toLowerCase()) loadMyTickets();
          // keep the description for convenience but you can clear it
          // $('#issue').value = '';
        } else {
          submitMsg.textContent = 'Failed to submit.';
        }
      } catch (e) {
        submitMsg.textContent = 'Network error.';
      }
    });

    // -------- My tickets list / actions --------
    const myEmail = $('#myEmail'), myMsg = $('#myMsg'), myList = $('#myList');
    $('#btnLoad').addEventListener('click', loadMyTickets);
    // convenience: mirror email from submit form
    $('#email').addEventListener('blur', () => {
      if (!myEmail.value) myEmail.value = $('#email').value;
    });

    function rowHtml(t) {
      const esc = (s) => String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
      return `
        <tr data-id="${t.id}">
          <td>#${t.id}</td>
          <td class="small">${esc(t.ts_local||'')}</td>
          <td>${esc(t.issue||'')}</td>
          <td><span class="pill">${esc(t.status||'New')}</span></td>
          <td class="small">
            <div class="flex">
              <button class="btn-ok" data-action="set" data-status="Resolved" title="Mark Resolved">Resolve</button>
              <button class="btn-warn" data-action="set" data-status="In Progress" title="Mark In Progress">In Progress</button>
              <button class="btn-bad" data-action="del" title="Delete ticket">Delete</button>
            </div>
          </td>
        </tr>`;
    }

    async function loadMyTickets() {
      const email = myEmail.value.trim();
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        myMsg.textContent = 'Enter a valid email.'; return;
      }
      myMsg.textContent = 'Loading…';
      myList.innerHTML = '';
      try {
        const r = await fetch(base + '/api/my-tickets?email=' + encodeURIComponent(email));
        const j = await r.json();
        if (!j?.ok) throw new Error('Bad response');
        if (!j.tickets?.length) {
          myMsg.textContent = 'No tickets yet.';
          return;
        }
        myMsg.textContent = `${j.tickets.length} ticket(s).`;
        const rows = j.tickets.map(rowHtml).join('');
        myList.innerHTML = `
          <table class="table">
            <thead><tr><th>ID</th><th>Submitted</th><th>Issue</th><th>Status</th><th>Actions</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
      } catch (e) {
        myMsg.textContent = 'Failed to load.';
      }
    }

    // delegate clicks for actions
    myList.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button'); if (!btn) return;
      const tr  = ev.target.closest('tr'); if (!tr) return;
      const id  = tr.getAttribute('data-id');
      const email = myEmail.value.trim();

      if (btn.dataset.action === 'set') {
        const status = btn.dataset.status;
        btn.disabled = true;
        try {
          const r = await fetch(base + `/api/my-tickets/${id}/status`, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ email, status })
          });
          const j = await r.json();
          if (j?.ok) {
            // update row status pill
            tr.querySelector('.pill').textContent = status;
          } else {
            alert('Failed to update: ' + (j?.error||''));
          }
        } catch {
          alert('Network error while updating.');
        } finally {
          btn.disabled = false;
        }
      }

      if (btn.dataset.action === 'del') {
        if (!confirm('Delete this ticket?')) return;
        btn.disabled = true;
        try {
          // Use JSON body variant (supported by the server)
          const r = await fetch(base + `/api/my-tickets/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ email })
          });
          const j = await r.json();
          if (j?.ok) {
            tr.remove();
          } else {
            alert('Failed to delete: ' + (j?.error||'')); 
          }
        } catch {
          alert('Network error while deleting.');
        } finally {
          btn.disabled = false;
        }
      }
    });

    // optional: auto-load when page opens if email known (handy for testing)
    window.addEventListener('load', () => {
      if (myEmail.value) loadMyTickets();
    });
  </script>
</body>
</html>
